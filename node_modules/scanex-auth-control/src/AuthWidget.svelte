<script>
    import {createEventDispatcher, onMount} from 'svelte';
    import {getAuthManager, getResourceServer} from './api.js';
    import T from 'scanex-translations';
    import './main.css';
    import './icons.css';
    import './AuthWidget.css';

    T.addText('rus', {
        auth: {
            'login': 'Войти',
            'logout': 'Выйти',
        }
    });

    T.addText('eng', {
        auth: {
            'login': 'Login',
            'logout': 'Logout',            
        }
    });

    let authenticated = false;
    export let user;

    const authManager = getAuthManager();

    const rsGmx = getResourceServer('geomixer');

    const dispatch = createEventDispatcher();

    onMount(() => {        
        authManager.getUserInfo()
        .then(response => {
            authenticated = true;         
            user = response.Result;
            const sync = authManager.$getAntiCsrfToken();
            dispatch('login', sync);
        })
        .catch((response) => {
            authenticated = false;
            dispatch('denied');
        });
    });

    export function login () {
        authManager.login();        
    }

    export function logout () {
        authManager.logout()
        .then(() => {
            authenticated = false;
            user = null;
            window.location.reload();
            dispatch('logout');
        });
    }

</script>

<div class="auth-widget">
    {#if authenticated}
    <span class="name">{user.Nickname}</span>
    <i class="icon logout" on:click|stopPropagation="{logout}" title="{T.getText('auth.logout')}"></i>
    {:else}    
    <i class="icon login" on:click|stopPropagation="{login}" title="{T.getText('auth.login')}"></i>
    {/if}
</div>